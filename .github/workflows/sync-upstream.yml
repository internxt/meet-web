name: Sync Upstream

# Permisos mínimos con GITHUB_TOKEN
permissions:
    contents: write
    pull-requests: write

on:
    workflow_dispatch:
    schedule:
        - cron: "0 0 1 * *"
    pull_request:
        branches: [main]

jobs:
    sync-upstream:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout fork
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Add upstream remote
              run: |
                  git remote add upstream https://github.com/jitsi/jitsi-meet.git || true
                  git fetch upstream

            - name: Create sync branch from upstream/master
              run: |
                  git checkout -B upstream-sync upstream/master

            - name: Remove upstream workflows (solve permission error)
              run: |
                  # Borramos todos los workflows del upstream para que GITHUB_TOKEN permita el push
                  rm -rf .github/workflows/
                  git add .github/workflows/ 2>/dev/null || echo "No workflows directory"
                  git commit -m "chore: remove upstream GitHub Actions workflows (auto-sync)" || echo "Nothing to commit"

            - name: Push sync branch (force)
              run: |
                  git push -f origin upstream-sync

            - name: Check if sync PR already exists
              id: check_pr
              run: |
                  if gh pr list --state open --head upstream-sync | grep -q upstream-sync; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                  fi

            - name: Create or update Pull Request
              if: steps.check_pr.outputs.exists == 'false'
              run: |
                  gh pr create \
                    --title "chore(sync): update from upstream jitsi/jitsi-meet" \
                    --body "Automated monthly sync with upstream repository.

                    - Upstream commit: $(git rev-parse --short upstream/master)
                    - Date: $(date -u)

                    Upstream workflows have been automatically removed to allow the sync.
                    Review changes carefully before merging." \
                    --base main \
                    --head upstream-sync

            - name: PR already exists notification
              if: steps.check_pr.outputs.exists == 'true'
              run: |
                  echo "Pull request already exists → nothing to do this month"
