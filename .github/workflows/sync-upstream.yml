name: Sync with Upstream

permissions:
    contents: write
    pull-requests: write

on:
    schedule:
        # Run at 00:00 UTC on the 1st of every month
        - cron: "0 0 1 * *"
    workflow_dispatch: # Allows manual trigger from GitHub Actions UI

jobs:
    sync-upstream:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.WORKFLOW_TOKEN }}

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Add upstream remote
              run: |
                  git remote add upstream https://github.com/jitsi/jitsi-meet.git || true
                  git fetch upstream

            - name: Detect upstream default branch
              id: detect_branch
              run: |
                  UPSTREAM_BRANCH=$(git remote show upstream | grep "HEAD branch" | cut -d ":" -f 2 | xargs)
                  echo "upstream_branch=$UPSTREAM_BRANCH" >> $GITHUB_OUTPUT
                  echo "Detected upstream branch: $UPSTREAM_BRANCH"

            - name: Check for upstream changes
              id: check_changes
              run: |
                  UPSTREAM_BRANCH="${{ steps.detect_branch.outputs.upstream_branch }}"
                  git fetch origin main
                  CHANGES=$(git rev-list --count origin/main..upstream/$UPSTREAM_BRANCH)
                  echo "changes_count=$CHANGES" >> $GITHUB_OUTPUT
                  echo "Number of commits to sync: $CHANGES"

                  if [ "$CHANGES" -eq 0 ]; then
                    echo "has_changes=false" >> $GITHUB_OUTPUT
                    echo "âœ… Repository is already up to date with upstream"
                  else
                    echo "has_changes=true" >> $GITHUB_OUTPUT
                    echo "ðŸ“¦ Found $CHANGES commits to sync"
                  fi

            - name: Create sync branch
              if: steps.check_changes.outputs.has_changes == 'true'
              id: create_branch
              run: |
                  BRANCH_NAME="sync-upstream-$(date +%Y-%m-%d)"
                  echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
                  git checkout -b "$BRANCH_NAME"

            - name: Merge upstream changes
              if: steps.check_changes.outputs.has_changes == 'true'
              id: merge
              continue-on-error: true
              run: |
                  UPSTREAM_BRANCH="${{ steps.detect_branch.outputs.upstream_branch }}"
                  if git merge upstream/$UPSTREAM_BRANCH --no-edit; then
                    echo "merge_success=true" >> $GITHUB_OUTPUT
                    echo "âœ… Merge successful"
                  else
                    echo "merge_conflict=true" >> $GITHUB_OUTPUT
                    echo "âš ï¸ Merge conflicts detected"
                    git merge --abort
                    git merge upstream/$UPSTREAM_BRANCH --no-commit --no-ff
                    git commit -m "sync: merge upstream changes from jitsi/jitsi-meet (with conflicts)"
                  fi

            - name: Push sync branch
              if: steps.check_changes.outputs.has_changes == 'true'
              run: |
                  git push origin ${{ steps.create_branch.outputs.branch_name }}

            - name: Prepare PR body from template
              if: steps.check_changes.outputs.has_changes == 'true'
              id: pr_body
              run: |
                  CONFLICT_NOTE=""
                  if [ "${{ steps.merge.outputs.merge_conflict }}" == "true" ]; then
                    CONFLICT_NOTE="âš ï¸ **Warning:** This PR contains merge conflicts that need to be resolved manually."
                  fi

                  CHANGES_COUNT="${{ steps.check_changes.outputs.changes_count }}"
                  UPSTREAM_BRANCH="${{ steps.detect_branch.outputs.upstream_branch }}"

                  # Create PR body
                  cat > /tmp/pr_body.md << 'EOFTEMPLATE'
                  ## Description

                  Synchronizes the fork with upstream [jitsi/jitsi-meet](https://github.com/jitsi/jitsi-meet).

                  **ðŸ“¦ Commits to sync:** CHANGES_COUNT_PLACEHOLDER from `upstream/UPSTREAM_BRANCH_PLACEHOLDER`

                  CONFLICT_NOTE_PLACEHOLDER

                  ## Related Issues

                  N/A - Automated upstream synchronization

                  ## Related Pull Requests

                  - [jitsi/jitsi-meet](https://github.com/jitsi/jitsi-meet/commits/UPSTREAM_BRANCH_PLACEHOLDER)

                  ## Checklist

                  - [ ] Changes have been tested locally.
                  - [ ] No new warnings or errors have been introduced.
                  - [ ] SonarCloud issues have been reviewed and addressed.
                  - [ ] Ensure no conflicts with Internxt-specific customizations.
                  - [ ] Verify all custom features still work correctly.
                  - [ ] QA Passed

                  ## How Has This Been Tested?

                  Run `npm run lint:ci && npm run tsc:ci && make dev` and test Internxt-specific features.

                  ## Additional Notes

                  ðŸ¤– Automatically created by the [sync-upstream workflow](.github/workflows/sync-upstream.yml).

                  # Replace placeholders
                  sed -i "s/CHANGES_COUNT_PLACEHOLDER/$CHANGES_COUNT/g" /tmp/pr_body.md
                  sed -i "s/UPSTREAM_BRANCH_PLACEHOLDER/$UPSTREAM_BRANCH/g" /tmp/pr_body.md
                  sed -i "s/SYNC_DATE_PLACEHOLDER/$(date +%Y-%m-%d)/g" /tmp/pr_body.md
                  sed -i "s/CONFLICT_NOTE_PLACEHOLDER/$CONFLICT_NOTE/g" /tmp/pr_body.md

            - name: Create Pull Request
              if: steps.check_changes.outputs.has_changes == 'true'
              env:
                  GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
              run: |
                  gh pr create \
                    --title "sync: merge upstream changes from jitsi/jitsi-meet" \
                    --body-file /tmp/pr_body.md \
                    --base main \
                    --head ${{ steps.create_branch.outputs.branch_name }}

            - name: No changes summary
              if: steps.check_changes.outputs.has_changes == 'false'
              run: |
                  echo "âœ… No sync needed - repository is already up to date with upstream"
