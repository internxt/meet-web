name: Sync Upstream

permissions:
    contents: write
    pull-requests: write

on:
    workflow_dispatch:
    schedule:
        - cron: "0 0 1 * *" # Día 1 de cada mes a las 00:00 UTC
    pull_request:
        branches: [main]

jobs:
    sync-upstream:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout fork
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: main # Aseguramos que partimos de main

            - name: Add upstream remote
              run: |
                  git remote add upstream https://github.com/jitsi/jitsi-meet.git || true
                  git fetch upstream

            - name: Create sync branch WITHOUT upstream workflows
              run: |
                  # Creamos la rama desde upstream/master, pero excluyendo workflows desde el inicio
                  git checkout -B upstream-sync upstream/master

                  # Borramos workflows inmediatamente (antes de cualquier commit)
                  rm -rf .github/workflows/

                  # Añadimos solo nuestros workflows locales (si existen) para preservarlos
                  if [ -d .github/workflows/ ]; then
                    echo "Preserving local workflows"
                  else
                    mkdir -p .github/workflows/
                    echo "# Preserved local workflows" > .github/workflows/sync-upstream.yml  # Placeholder para no dejar vacío
                  fi

                  # Commit de los cambios (borrado + preservación)
                  git add .github/workflows/ || true
                  git commit -m "chore(sync): remove upstream workflows and preserve ours" || echo "No changes to commit"

            - name: Push sync branch (force)
              run: |
                  git push -f origin upstream-sync

            - name: Check if sync PR already exists
              id: check_pr
              run: |
                  if gh pr list --state open --head upstream-sync | grep -q upstream-sync; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                  fi

            - name: Create Pull Request
              if: steps.check_pr.outputs.exists == 'false'
              run: |
                  gh pr create \
                    --title "chore(sync): monthly update from upstream jitsi/jitsi-meet" \
                    --body "Automated sync with upstream (commit: \$(git rev-parse --short upstream/master)).
